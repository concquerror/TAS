-- Tak na początek :)

Create Database Bookshop

-- 1. Tworzenie table

Create Table Books(
	Id Int Not Null primary key,
	Name Varchar(50) check(Name like '%') Not Null,
	Authors Varchar(30) Not Null,
	Publisher Varchar(15) Not Null,
	Year Int Not Null,
	State Varchar(15) check(Name like ‘Dostępna’ or ‘Nie dostępna’)
);
Create Table Archive(
	Name Varchar(50) check(Name like '%') Not Null,
	Authors Varchar(30) Not Null,
	Publisher Varchar(15) Not Null,
	Year Int Not Null,
);
Create Table eBooks(
	Id Int Not Null primary key,
	Name Varchar(50) check(Name like '%') Not Null,
	Authors Varchar(30) Not Null,
	Publisher Varchar(15) Not Null,
	Year Int Not Null,
	State Varchar(15) check(Name like ‘Dostępna’ or ‘Niedostępna’)
);
Create Table Users(
	Id Int Not Null primary key,
	Name Varchar(50) check(Name like '%') Not Null,
	Sname Varchar(50) check(Sname like '%') Not Null,
	Birth Date Not Null,
	BooksBorrowed Int Default ‘0’,
	EBooksBorrowed Int Default ‘0’, 
);
Create Table BorrowedBooks(
	Id Int Not Null primary key,
	Name Varchar(50) check(Name like '%') Not Null,
	Authors Varchar(30) Not Null,
	Publisher Varchar(15) Not Null,
	Year Int Not Null,
	User Int Not Null,
);


ALTER TABLE Books
ADD CONSTRAINT FK_Books
FOREIGN KEY (Id)
REFERENCES BorrowedBooks(Id);

Create Trigger All1
ON Books 
AFTER INSERT
AS
	insert into Archive
	SELECT Name, Authors, Publisher, PYear
	FROM inserted;
GO

Create Trigger All2
ON EBooks 
AFTER INSERT
AS
	insert into Archive
	SELECT Name, Authors, Publisher, PYear
	FROM inserted;
GO



Create Procedure Borrowed
(
	@userid Int
)
as
	select *
	from BorrowedBooks
	where User = @userid
go



Create view AvailableB as
Select B.Id, B.Name, B.Authors, B.Publisher, B.PYear
from Books B
where B.BState='Dostępna'

Create view AvailableE as
Select B.Id, B.Name, B.Authors, B.Publisher, B.PYear
from eBooks B
where B.BState='Dostępna'

ALTER TABLE Books 
NOCHECK CONSTRAINT FK_Books;
update Books
set BState='Nie dostępna'
where Id=1
ALTER TABLE Books 
CHECK CONSTRAINT FK_Books;

ALTER TABLE Books 
NOCHECK CONSTRAINT FK_Books;
Delete 
FROM Books
WHERE Id=1
ALTER TABLE Books 
CHECK CONSTRAINT FK_Books;

ALTER TABLE Books 
NOCHECK CONSTRAINT FK_Books;
Insert into Books Values (1, 'Wiedźmin 1','Andrzej Sapkowski','Nowa Era',1999,'Dostępna')
ALTER TABLE Books 
CHECK CONSTRAINT FK_Books;
